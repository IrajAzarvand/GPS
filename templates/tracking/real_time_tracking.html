{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}ردیابی زنده {{ device.name }}{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
.real-time-container {
    position: relative;
    height: calc(100vh - 200px);
}

#map {
    height: 100%;
    width: 100%;
    border-radius: 8px;
}

.status-panel {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    min-width: 250px;
}

.status-item {
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.status-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.status-label {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 3px;
}

.status-value {
    font-weight: bold;
    color: #007bff;
}

.status-online {
    color: #28a745;
}

.status-offline {
    color: #dc3545;
}

.control-panel {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
}

.control-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.btn-control {
    padding: 8px 12px;
    border: 1px solid #007bff;
    background: white;
    color: #007bff;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9em;
    text-align: center;
    transition: all 0.2s;
}

.btn-control:hover {
    background: #007bff;
    color: white;
    text-decoration: none;
}

.btn-control.active {
    background: #007bff;
    color: white;
}

.btn-control.danger {
    border-color: #dc3545;
    color: #dc3545;
}

.btn-control.danger:hover {
    background: #dc3545;
    color: white;
}

.live-indicator {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(40, 167, 69, 0.9);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    z-index: 1000;
    display: none;
}

.live-indicator::before {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    margin-left: 8px;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.alert-notification {
    position: fixed;
    top: 20px;
    left: 20px;
    background: #dc3545;
    color: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 10000;
    max-width: 300px;
    display: none;
    cursor: pointer;
}

.alert-notification.show {
    display: block;
}

.alert-notification:hover {
    opacity: 0.9;
}

.tracking-path {
    stroke: #007bff;
    stroke-width: 4;
    fill: none;
}

.current-position {
    fill: #28a745;
    stroke: white;
    stroke-width: 2;
}

.geofence-area {
    fill: rgba(220, 53, 69, 0.2);
    stroke: #dc3545;
    stroke-width: 2;
}
</style>
{% endblock %}

{% block content %}
<div class="real-time-container">
    <!-- Map -->
    <div id="map"></div>

    <!-- Live Indicator -->
    <div id="live-indicator" class="live-indicator">
        ردیابی زنده فعال
    </div>

    <!-- Status Panel -->
    <div class="status-panel">
        <h5 class="mb-3">{{ device.name }}</h5>

        <div class="status-item">
            <div class="status-label">وضعیت اتصال</div>
            <div id="connection-status" class="status-value status-offline">در حال اتصال...</div>
        </div>

        <div class="status-item">
            <div class="status-label">آخرین بروزرسانی</div>
            <div id="last-update" class="status-value">-</div>
        </div>

        <div class="status-item">
            <div class="status-label">موقعیت فعلی</div>
            <div id="current-position" class="status-value">-</div>
        </div>

        <div class="status-item">
            <div class="status-label">سرعت</div>
            <div id="current-speed" class="status-value">-</div>
        </div>

        <div class="status-item">
            <div class="status-label">باتری</div>
            <div id="battery-level" class="status-value">-</div>
        </div>

        <div class="status-item">
            <div class="status-label">زمان اتصال</div>
            <div id="connection-time" class="status-value">-</div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <div class="control-buttons">
            <a href="#" id="btn-start" class="btn-control active">
                <i class="fas fa-play"></i> شروع
            </a>
            <a href="#" id="btn-stop" class="btn-control">
                <i class="fas fa-stop"></i> توقف
            </a>
            <a href="#" id="btn-center" class="btn-control">
                <i class="fas fa-crosshairs"></i> مرکز
            </a>
            <a href="{% url 'tracking:device_tracking' device.id %}" class="btn-control">
                <i class="fas fa-history"></i> تاریخچه
            </a>
            <a href="#" id="btn-fullscreen" class="btn-control">
                <i class="fas fa-expand"></i> تمام صفحه
            </a>
        </div>
    </div>

    <!-- Alert Notification -->
    <div id="alert-notification" class="alert-notification">
        <h6><i class="fas fa-exclamation-triangle"></i> هشدار</h6>
        <p id="alert-message">هشداری دریافت شد</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let currentMarker = null;
let pathLayer = null;
let geofenceLayers = [];
let isTracking = false;
let lastUpdate = null;
let connectionStartTime = null;
let updateInterval;
let pathCoordinates = [];

const deviceId = {{ device.id }};
const deviceName = '{{ device.name }}';

// Initialize map
function initMap() {
    // Default to Tehran coordinates if no device location
    const defaultLat = {{ device.last_location_lat|default:"35.6892" }};
    const defaultLng = {{ device.last_location_lng|default:"51.3890" }};

    map = L.map('map').setView([defaultLat, defaultLng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Add current position marker if available
    {% if device.last_location_lat and device.last_location_lng %}
    updateCurrentPosition({{ device.last_location_lat }}, {{ device.last_location_lng }}, '{{ device.last_location_time|date:"H:i:s Y/m/d" }}');
    {% endif %}

    // Load geofences
    loadGeofences();
}

// Update current position
function updateCurrentPosition(lat, lng, timestamp, speed = null, battery = null) {
    // Remove previous marker
    if (currentMarker) {
        map.removeLayer(currentMarker);
    }

    // Add new marker
    currentMarker = L.circleMarker([lat, lng], {
        color: '#28a745',
        fillColor: '#28a745',
        fillOpacity: 1,
        radius: 8,
        weight: 2
    }).addTo(map);

    currentMarker.bindPopup(`
        <b>${deviceName}</b><br>
        موقعیت: ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
        زمان: ${timestamp}
        ${speed ? `<br>سرعت: ${speed} km/h` : ''}
        ${battery ? `<br>باتری: ${battery}%` : ''}
    `);

    // Add to path
    pathCoordinates.push([lat, lng]);

    // Update path
    updatePath();

    // Update status panel
    document.getElementById('current-position').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    document.getElementById('last-update').textContent = timestamp;
    document.getElementById('connection-status').textContent = 'آنلاین';
    document.getElementById('connection-status').className = 'status-value status-online';

    if (speed !== null) {
        document.getElementById('current-speed').textContent = `${speed} km/h`;
    }

    if (battery !== null) {
        document.getElementById('battery-level').textContent = `${battery}%`;
    }

    lastUpdate = new Date();
}

// Update path
function updatePath() {
    if (pathLayer) {
        map.removeLayer(pathLayer);
    }

    if (pathCoordinates.length > 1) {
        pathLayer = L.polyline(pathCoordinates, {
            color: '#007bff',
            weight: 4,
            opacity: 0.8
        }).addTo(map);
    }
}

// Load geofences
function loadGeofences() {
    // This would load geofences via AJAX in a real implementation
    // For now, we'll skip this as geofences are handled in device_tracking.html
}

// Start real-time tracking
function startTracking() {
    if (isTracking) return;

    isTracking = true;
    connectionStartTime = new Date();

    document.getElementById('btn-start').classList.remove('active');
    document.getElementById('btn-stop').classList.add('active');
    document.getElementById('live-indicator').style.display = 'block';

    updateConnectionTime();

    // Simulate real-time updates (in production, this would use WebSockets or Server-Sent Events)
    updateInterval = setInterval(() => {
        fetchLatestLocation();
    }, 10000); // Update every 10 seconds

    // Initial fetch
    fetchLatestLocation();
}

// Stop tracking
function stopTracking() {
    if (!isTracking) return;

    isTracking = false;

    document.getElementById('btn-stop').classList.remove('active');
    document.getElementById('btn-start').classList.add('active');
    document.getElementById('live-indicator').style.display = 'none';

    if (updateInterval) {
        clearInterval(updateInterval);
    }

    document.getElementById('connection-status').textContent = 'آفلاین';
    document.getElementById('connection-status').className = 'status-value status-offline';
}

// Fetch latest location
function fetchLatestLocation() {
    fetch(`{% url 'tracking:get_device_locations' device.id %}?hours=1&limit=1`)
        .then(response => response.json())
        .then(data => {
            if (data.locations && data.locations.length > 0) {
                const location = data.locations[0];
                updateCurrentPosition(
                    location.latitude,
                    location.longitude,
                    new Date(location.timestamp).toLocaleString('fa-IR'),
                    location.speed,
                    location.battery_level
                );
            }
        })
        .catch(error => {
            console.error('Error fetching location:', error);
            document.getElementById('connection-status').textContent = 'خطا در اتصال';
            document.getElementById('connection-status').className = 'status-value status-offline';
        });
}

// Update connection time
function updateConnectionTime() {
    if (!connectionStartTime || !isTracking) {
        document.getElementById('connection-time').textContent = '-';
        return;
    }

    const now = new Date();
    const diff = Math.floor((now - connectionStartTime) / 1000);

    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;

    document.getElementById('connection-time').textContent =
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Center map on current position
function centerMap() {
    if (currentMarker) {
        map.setView(currentMarker.getLatLng(), 15);
    }
}

// Toggle fullscreen
function toggleFullscreen() {
    const container = document.querySelector('.real-time-container');

    if (!document.fullscreenElement) {
        container.requestFullscreen().catch(err => {
            console.error('Error attempting to enable fullscreen:', err);
        });
    } else {
        document.exitFullscreen();
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    initMap();

    // Control buttons
    document.getElementById('btn-start').addEventListener('click', function(e) {
        e.preventDefault();
        startTracking();
    });

    document.getElementById('btn-stop').addEventListener('click', function(e) {
        e.preventDefault();
        stopTracking();
    });

    document.getElementById('btn-center').addEventListener('click', function(e) {
        e.preventDefault();
        centerMap();
    });

    document.getElementById('btn-fullscreen').addEventListener('click', function(e) {
        e.preventDefault();
        toggleFullscreen();
    });

    // Update connection time every second
    setInterval(updateConnectionTime, 1000);

    // Alert notification click
    document.getElementById('alert-notification').addEventListener('click', function() {
        this.classList.remove('show');
    });

    // Handle fullscreen changes
    document.addEventListener('fullscreenchange', function() {
        const btn = document.getElementById('btn-fullscreen');
        const icon = btn.querySelector('i');

        if (document.fullscreenElement) {
            icon.className = 'fas fa-compress';
        } else {
            icon.className = 'fas fa-expand';
        }
    });
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopTracking();
});

// Handle visibility change (pause when tab is not visible)
document.addEventListener('visibilitychange', function() {
    if (document.hidden && isTracking) {
        // Could pause updates when tab is not visible to save resources
        // For now, we'll keep it running
    }
});
</script>
{% endblock %}